<!DOCTYPE html>
<html lang="en">

<head>
    <style>
        body {
            margin: 0px;
            padding: 0px;
            overflow: hidden;
            background-color: #DDFFBC;
        }

        #app {
            position: absolute;
            left: 10%;
            top: 5%;
            display: block;
            max-width: 800px;
			max-height: 700px;
            background-color: #52734D;
            width: 80%;
            height: 76%;
        }

    </style>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport" />
    <title>ChatGPT (Implemented by OpenAI's GPT-3 API)</title>
    <script src="./js/axios.min.js"></script>
</head>

<body>
    <div id="app">
        <div style="display: flex;justify-content: center;align-items: center;color:#eee;">
            ChatGPT Persistent Chat AI
        </div>
        <div style="display: flex;justify-content: center;align-items: center;">
            <textarea id="res" cols="100" rows="22"></textarea>
        </div>
        <div style="color:#eee;">
            Enter questions or task prompts: <br /> (Use the /help command to get more help)
        </div>
        <div>
        </div>
        <div style="display: flex;justify-content: center;align-items: center">
            <textarea id="inputbox" type="text" v-model="info" cols="100" rows="8" style="margin:15"></textarea>
        </div>
        <div style="display: flex;justify-content: center;align-items: center;margin-top:5px;">
            <button onclick="ask()" style="width: 100%;">Send</button>
        </div>
        <br />
    </div>

    <script>
        window.apikey = "";
        window.prompt1 = "";
        window.mt = 3900;
        window.tpr = 1;
        window.tp = 1;
        window.fp = 0;
        window.pp = 0;
        window.mode = "true";
        window.csize = 2000;
        const textarea = window.document.getElementById("res");
        const inputbox = window.document.getElementById("inputbox");
        var histories = "";
        addText("Welcome to HTML ChatGPT-3, this project is developed based on the GPT-3 API, which can achieve the similar persistent dialogue function as ChatGPT, and the AI ​​will remember and combine the context of the conversation.");	
        if (getCookie("apikey") != undefined && getCookie("apikey") != "") {
            window.apikey = getCookie("apikey");
        } else {
            window.apikey = prompt("Please enter and submit the apikey you obtained from the official website in the input box:");
            setCookie("apikey", window.apikey);
        }
        if (getCookie("prompt1") != undefined) {
            window.prompt1 = getCookie("prompt1");
        }
        if (getCookie("mt") != undefined) {
            window.mt = Number(getCookie("mt"));
        }
        if (getCookie("tpr") != undefined) {
            window.tpr = Number(getCookie("tpr"));
        }
        if (getCookie("tp") != undefined) {
            window.tp = Number(getCookie("tp"));
        }
        if (getCookie("fp") != undefined) {
            window.fp = Number(getCookie("fp"));
        }
        if (getCookie("pp") != undefined) {
            window.pp = Number(getCookie("pp"));
        }
        if (getCookie("mode") != undefined) {
            window.mode = getCookie("mode");
        }
        if (getCookie("csize") != undefined) {
            window.csize = Number(getCookie("csize"));
        }
        function ask() {
            let intputtext = inputbox.value;
            if (intputtext.startsWith("/")) {
                intputtext = intputtext.substring(1);
                switch (intputtext) {
                    case "help":
                        addText("Enter the following commands to change the parameters of ChatGPT:\n\n" +
                        "/apikey  (OpenAI API key to authenticate the API request. Get from https://platform.openai.com/account/api-keys)\n" +
                        "/prompt  (add pre-context to each text sent)\n" +
                        "/maxtoken  (control the number of words generated by ChatGPT each time.)\n" +
                        "/tpr (control the diversity of chatbot's response. Higher values means the model will take more risks. Try 0.9 for more creative applications, and 0 for ones with a well-defined answer.)\n" +
                        "/top  (An alternative to sampling with temperature, called nucleus sampling, where the model considers the results of the tokens with top_p probability mass. So 0.1 means only the tokens comprising the top 10% probability mass are considered. It is generally recommended to alter this or temperature but not both.)\n" +
                        "/fp  (Frequency_penalty, number between -2.0 and 2.0. Positive values penalize new tokens based on their existing frequency in the text so far, decreasing the model's likelihood to repeat the same line verbatim.)\n" +
                        "/pp  (Presence_penalty, number between -2.0 and 2.0. Positive values penalize new tokens based on whether they appear in the text so far, increasing the model's likelihood to talk about new topics.)\n" +
                        "/info  (display the current values of each parameter)\n" +
                        "/mode  (set whether to enable persistent dialogue mode)\n" +
                        "/csize  (set the number of characters sent to the API interface each time)\n" +
                        "/save  (save the set parameters to the browser's cookie, valid for 30 days)");
                    break;
                    case "info": addText(
                        "Current parameters:\n\n" +
                        "apikey:" + window.apikey + "\n\n" +
                        "Prompt:" + window.prompt1 + "\n\n" +
                        "Max_tokens:" + window.mt + "\n" +
                        "Temperature:" + window.tpr + "\n" +
                        "Top_p:" + window.tp + "\n" +
                        "Frequency_penalty:" + window.fp + "\n" +
                        "Presence_penalty:" + window.pp + "\n" +
                        "mode:" + window.mode + "\n" +
                        "csize:" + window.csize);
                        break;
                    case "save":
                        setCookie("apikey", window.apikey);
                        setCookie("prompt1", window.prompt1);
                        setCookie("mt", window.mt);
                        setCookie("tpr", window.tpr);
                        setCookie("tp", window.tp);
                        setCookie("fp", window.fp);
                        setCookie("pp", window.pp);
                        setCookie("mode", window.mode);
                        setCookie("csize", window.csize);
                        addText("Parameter saved successfully, data will be saved for 30 days");
                        break;
                    case "apikey": window.apikey = prompt("Apikey Please enter the apikey obtained from the official website, default is empty"); addText("Set successfully"); break;
                    case "prompt": window.prompt1 = prompt("Prompt Please enter the context text to be added, default is empty"); addText("Set successfully"); break;
                    case "maxtoken": window.mt = Number(prompt("Max_tokens Please enter the number of words ChatGPT can generate each time, default is 2048")); addText("Set successfully"); break;
                    case "tpr": window.tpr = Number(prompt("Temperature Please enter a decimal number from 0 to 1.0, default is 1.0")); addText("Set successfully"); break;
                    case "top": window.tp = Number(prompt("Top_p Please enter a decimal number from 0 to 1.0, default is 1.0")); addText("Set successfully"); break;
                    case "fp": window.fp = Number(prompt("Frequency_penalty Please enter a decimal number from -2.0 to 2.0, default is 0")); addText("Set successfully"); break;
                    case "pp": window.pp = Number(prompt("Presence_penalty Please enter a decimal number from -2.0 to 2.0, default is 0")); addText("Set successfully"); break;
                    case "mode": window.mode = prompt("mode Enter 'true' to turn on continuous conversation mode, enter 'false' to turn off this mode, default is 'true'"); addText("Set successfully"); break;
                    case "csize": window.csize = prompt("csize Enter an integer from 0 to 1000, default is 1000"); addText("Set successfully"); break;
                    default: alert("Unknown command");
                }
                inputbox.value = "";
                return;
            }
            if (window.mode == "false") {
                histories = [];
            }
            histories += "\n" + window.prompt1 + "\nQ:" + intputtext + "。";
            let question = "";
            if (histories.length <= window.csize) {
                question = histories;
            } else {
                question = histories.substring(histories.length - window.csize)
            }
            console.log(question);
            addText("I said:\n\n" + intputtext);
            textarea.value += '\nRequesting data......';
            textarea.scrollTop = textarea.scrollHeight;
            axios.post('https://api.openai.com/v1/completions', {
                prompt: question, max_tokens: window.mt, model: "text-davinci-003", temperature: window.tpr,
                top_p: window.tp, frequency_penalty: window.fp, presence_penalty: window.pp
            }, {
                headers: { 'content-type': 'application/json', 'Authorization': 'Bearer ' + window.apikey }
            }).then(response => {
                let arr = textarea.value.split("\n");
                arr = arr.slice(0, arr.length - 1);
                textarea.value = arr.join("\n");
                let result = response.data.choices[0].text;
                histories += "\n" + result;
                let result1 = result;
                addText("AI said:\n" + result1.replace('A:', '').replace('A：', ''));
                inputbox.value = "";
            }).catch(error => {
                console.log(error);
                alert("Server error:\n" + error);
            });
        }
        function addText(text) {
            textarea.value += "\n" + text + "\n" + "————————————————————";
            textarea.scrollTop = textarea.scrollHeight;
        }
        // 添加cookie
        function setCookie(name, value) {
            let days = 10;
            var expires = '';
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = '; expires=' + date.toUTCString();
            }
            document.cookie = name + '=' + (value || '') + expires + '; path=/';
        }

        // 读取cookie
        function getCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

    </script>

</body>

</html>
